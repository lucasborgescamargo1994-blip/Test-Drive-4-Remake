<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Test Drive 4 Remake - Winter City Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        canvas { display: block; }
        
        /* MENU INICIAL */
        #menu-container {
            position: absolute; width: 100%; height: 100%;
            background: linear-gradient(45deg, #1a1a1a, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000;
        }
        .menu-card {
            background: rgba(20, 20, 20, 0.95); padding: 40px; border-radius: 15px;
            border: 2px solid #ffcc00; text-align: center; backdrop-filter: blur(10px); width: 380px;
        }
        h1 { color: #ffcc00; margin: 0 0 20px 0; font-style: italic; letter-spacing: 2px; }
        .field { margin-bottom: 20px; text-align: left; }
        label { display: block; font-size: 11px; color: #ffcc00; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; }
        select, input { width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #444; background: #111; color: white; box-sizing: border-box; }
        button { 
            width: 100%; padding: 15px; border-radius: 5px; border: none; 
            background: #ffcc00; color: #000; font-weight: bold; font-size: 18px;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        button:hover { background: #fff; transform: scale(1.05); }

        /* HUD JOGO */
        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        .dial-container {
            position: absolute; bottom: 30px; right: 30px; width: 160px; height: 160px;
            background: radial-gradient(circle, rgba(0,0,0,0.8) 20%, #111 100%);
            border-radius: 50%; border: 4px solid #555; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #speed-val { font-size: 50px; font-weight: 900; font-style: italic; color: #fff; text-shadow: 0 0 10px #0088ff; line-height: 1; }
        #gear-disp { position: absolute; bottom: -10px; background: #ffcc00; color: #000; padding: 5px 20px; border-radius: 10px; font-weight: bold; }
        #loading-screen { position: absolute; width: 100%; height: 100%; background: #000; display: none; justify-content: center; align-items: center; z-index: 3000; font-size: 20px; color: #ffcc00; }
    </style>
</head>
<body>

<div id="loading-screen">SINCRONIZANDO COM GITHUB...</div>

<div id="menu-container">
    <div class="menu-card">
        <h1>TD4 REMAKE</h1>
        <div class="field">
            <label>Escolha seu Carro</label>
            <select id="player-car-select"></select>
        </div>
        <div class="field">
            <label>Número de Oponentes</label>
            <input type="number" id="bot-count" value="3" min="0" max="10">
        </div>
        <div class="field">
            <label>Selecione a Pista</label>
            <select id="track-select">
                <option value="custom">Winter City (Burnout 3 GLB)</option>
                <option value="original">Pista de Teste (Procedural)</option>
            </select>
        </div>
        <button id="start-btn">INICIAR CORRIDA</button>
    </div>
</div>

<div id="hud-layer">
    <div style="position: absolute; top: 20px; left: 20px;">
        <div style="background:rgba(0,0,0,0.8); padding:15px; border-left: 5px solid #ffcc00;">
            <div style="font-size:11px; color:#bbb;">CRONÔMETRO</div>
            <div id="timer" style="font-size:24px; font-weight: bold; font-family: monospace;">00:00.00</div>
        </div>
    </div>
    <div class="dial-container">
        <div id="speed-val">0</div>
        <div style="font-size:12px; color:#aaa;">MPH</div>
        <div id="gear-disp">N</div>
    </div>
</div>

<script type="importmap">
  { "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // CONFIGURAÇÕES GLOBAIS - LINKS RAW CORRETOS
    const GITHUB_BASE = "https://raw.githubusercontent.com/lucasborgescamargo1994-blip/Test-Drive-4-Remake/main/";
    const TRACK_URL = GITHUB_BASE + "burnout_3_winter_city.glb";
    
    const CAR_MODELS = [
        { name: "Shelby Cobra", file: "cobra.glb" },
        { name: "Jaguar XJ220", file: "jaguar.glb" },
        { name: "Viper RT/10", file: "viper.glb" }
    ];

    const PHYSICS = { maxSpeed: 2.8, accel: 0.02, brake: 0.05, friction: 0.98, turn: 0.038 };

    let scene, camera, renderer, clock, curve;
    let player = { mesh: null, speed: 0, velocity: new THREE.Vector3(), lastSafePos: new THREE.Vector3(0, 2, 0) };
    let opponents = [];
    let trackMesh = null;
    let gameStarted = false;
    let currentTrackType = 'original';
    const keys = { w: false, a: false, s: false, d: false };

    // Popular Menu
    const carSelect = document.getElementById('player-car-select');
    CAR_MODELS.forEach((car, i) => {
        let opt = document.createElement('option');
        opt.value = i; opt.textContent = car.name;
        carSelect.appendChild(opt);
    });

    document.getElementById('start-btn').onclick = startRace;

    function initThree() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 100, 800);
        clock = new THREE.Clock();

        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 3000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const sun = new THREE.DirectionalLight(0xffffff, 1.4);
        sun.position.set(100, 200, 100);
        sun.castShadow = true;
        scene.add(sun);
    }

    function createOriginalTrack() {
        const points = [
            new THREE.Vector3(0, 0, 0), new THREE.Vector3(100, 2, 150),
            new THREE.Vector3(350, 10, 200), new THREE.Vector3(500, 5, 0),
            new THREE.Vector3(300, -2, -250), new THREE.Vector3(100, 0, -150)
        ];
        curve = new THREE.CatmullRomCurve3(points);
        curve.closed = true;

        const shape = new THREE.Shape();
        const tw = 10;
        shape.moveTo(-tw, 0); shape.lineTo(tw, 0); shape.lineTo(tw, 0.5); shape.lineTo(-tw, 0.5);
        
        const geo = new THREE.ExtrudeGeometry(shape, { steps: 150, extrudePath: curve, bevelEnabled: false });
        trackMesh = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: 0x444444 }));
        scene.add(trackMesh);
    }

    async function loadCar(file, isPlayer, index = 0) {
        const loader = new GLTFLoader();
        try {
            const gltf = await loader.loadAsync(GITHUB_BASE + file);
            const mesh = gltf.scene;
            scene.add(mesh);
            if(isPlayer) player.mesh = mesh;
            else {
                opponents.push({ mesh, progress: index * 0.03, sideOffset: (index % 2 === 0 ? 4 : -4) });
            }
        } catch (e) {
            console.error("Erro ao carregar carro:", file);
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(2,1,4), new THREE.MeshStandardMaterial({color: isPlayer?0xff0000:0x0000ff}));
            scene.add(mesh);
            if(isPlayer) player.mesh = mesh; else opponents.push({ mesh, progress: index * 0.03, sideOffset: 0 });
        }
    }

    async function startRace() {
        currentTrackType = document.getElementById('track-select').value;
        document.getElementById('menu-container').style.display = 'none';
        document.getElementById('loading-screen').style.display = 'flex';

        initThree();

        // Lógica de Pista
        if(currentTrackType === 'custom') {
            const loader = new GLTFLoader();
            try {
                const gltf = await loader.loadAsync(TRACK_URL);
                trackMesh = gltf.scene;
                scene.add(trackMesh);
                trackMesh.scale.set(1, 1, 1); // Ajuste aqui se a pista do Burnout for pequena
            } catch (e) {
                console.error("Falha ao carregar arquivo GLB do GitHub. Usando pista teste.");
                createOriginalTrack();
                currentTrackType = 'original';
            }
        } else {
            createOriginalTrack();
        }

        // Carregar Jogador e Bots
        const playerIdx = document.getElementById('player-car-select').value;
        const botCount = parseInt(document.getElementById('bot-count').value);

        await loadCar(CAR_MODELS[playerIdx].file, true);

        for(let i = 0; i < botCount; i++) {
            const model = CAR_MODELS[i % CAR_MODELS.length];
            await loadCar(model.file, false, i + 1);
        }

        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('hud-layer').style.display = 'block';

        window.addEventListener('keydown', e => handleKey(e, true));
        window.addEventListener('keyup', e => handleKey(e, false));
        gameStarted = true;
        animate();
    }

    function handleKey(e, state) {
        const k = e.key.toLowerCase();
        if(k === 'w' || e.key === 'ArrowUp') keys.w = state;
        if(k === 's' || e.key === 'ArrowDown') keys.s = state;
        if(k === 'a' || e.key === 'ArrowLeft') keys.a = state;
        if(k === 'd' || e.key === 'ArrowRight') keys.d = state;
    }

    function updatePhysics() {
        if(!player.mesh || !trackMesh) return;

        if(keys.w) player.speed += PHYSICS.accel;
        if(keys.s) player.speed -= PHYSICS.brake;
        player.speed *= PHYSICS.friction;
        player.speed = Math.max(Math.min(player.speed, PHYSICS.maxSpeed), -0.5);

        if(Math.abs(player.speed) > 0.05) {
            const dir = player.speed > 0 ? 1 : -1;
            if(keys.a) player.mesh.rotation.y += PHYSICS.turn * dir;
            if(keys.d) player.mesh.rotation.y -= PHYSICS.turn * dir;
        }

        const move = new THREE.Vector3(0,0,1).applyQuaternion(player.mesh.quaternion).multiplyScalar(player.speed);
        const nextPos = player.mesh.position.clone().add(move);

        // Raycast Híbrido (Funciona na pista original e na GLB)
        const ray = new THREE.Raycaster(nextPos.clone().add(new THREE.Vector3(0, 15, 0)), new THREE.Vector3(0, -1, 0));
        const hits = ray.intersectObject(trackMesh, true);

        if(hits.length > 0) {
            player.mesh.position.copy(nextPos);
            player.mesh.position.y = hits[0].point.y;
            player.lastSafePos.copy(player.mesh.position);
        } else {
            player.speed *= 0.8;
            player.mesh.position.lerp(player.lastSafePos, 0.1);
        }
    }

    function animate() {
        if(!gameStarted) return;
        requestAnimationFrame(animate);
        const dt = clock.getDelta();

        updatePhysics();

        // Movimentação dos Bots
        opponents.forEach(bot => {
            if(currentTrackType === 'original' && curve) {
                bot.progress = (bot.progress + 0.0003) % 1;
                const pos = curve.getPointAt(bot.progress);
                bot.mesh.position.copy(pos).y += 0.5;
                bot.mesh.lookAt(curve.getPointAt((bot.progress + 0.01) % 1));
            } else {
                bot.mesh.translateZ(0.6); // Na pista GLB eles apenas andam reto por enquanto
                bot.mesh.rotation.y += 0.005;
            }
        });

        // Câmera Perseguição
        if(player.mesh) {
            const camPos = player.mesh.position.clone().add(new THREE.Vector3(0, 4, -12).applyQuaternion(player.mesh.quaternion));
            camera.position.lerp(camPos, 0.12);
            camera.lookAt(player.mesh.position);
        }

        // HUD
        const mph = Math.floor(Math.abs(player.speed) * 115);
        document.getElementById('speed-val').innerText = mph;
        document.getElementById('timer').innerText = clock.getElapsedTime().toFixed(2);
        document.getElementById('gear-disp').innerText = mph < 10 ? "N" : (mph < 80 ? "1" : "2");

        renderer.render(scene, camera);
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>TD4 Engine Pro - Fixed</title>
    <style>
        /* Mantendo seu estilo original exatamente como estava */
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Consolas', monospace; color: white; }
        #debug-panel {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.85);
            padding: 12px; border: 2px solid #ffcc00; font-size: 12px; z-index: 3000; pointer-events: none;
        }
        #ui-wrapper { position: absolute; width: 100%; height: 100%; z-index: 2000; }
        .menu-card { background: #222; padding: 25px; border-radius: 8px; border: 2px solid #444; text-align: center; }
        .btn { padding: 10px 20px; background: #ffcc00; color: black; border: none; cursor: pointer; font-weight: bold; margin: 5px; }
        .hidden { display: none !important; }
        #speedometer { position: absolute; bottom: 20px; right: 20px; font-size: 30px; color: #ffcc00; z-index: 1000; }
    </style>
</head>
<body>

<div id="ui-wrapper">
    <div id="menu-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #111;">
        <div class="menu-card">
            <h1>TEST DRIVE 4 REMAKE</h1>
            <button class="btn" onclick="startWithTrack()">START RACE</button>
        </div>
    </div>
</div>

<div id="speedometer" class="hidden">0 KM/H</div>
<div id="debug-panel" class="hidden">DEBUG MODE ACTIVE</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
    // Mantendo TODAS as suas variáveis e TRACK_DATA originais
    let scene, camera, renderer, trackMesh;
    let player = { mesh: null, speed: 0, currentCar: "cobra.glb", currentTrack: "burnout_3_winter_city.glb" };
    let keys = { w: false, a: false, s: false, d: false };
    let gameStarted = false;

    // A TRACK_DATA que estava no seu código original (resumida aqui, mas use a sua completa)
    const TRACK_DATA = [{"x":3895.20,"y":27.09,"z":454.58}, /* ... todos os seus pontos ... */];

    const loader = new THREE.GLTFLoader();

    function startWithTrack() {
        document.getElementById('ui-wrapper').classList.add('hidden');
        document.getElementById('speedometer').classList.remove('hidden');
        init();
    }

    function init() {
        scene = new THREE.Scene();
        // Aumentando a luz ambiente para evitar o "tudo preto" sem quebrar o material
        scene.add(new THREE.AmbientLight(0xffffff, 1.5)); 
        
        const sun = new THREE.DirectionalLight(0xffffff, 1.0);
        sun.position.set(100, 500, 100);
        scene.add(sun);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 20000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x87ceeb); // Fundo azul para garantir que o mundo existe
        document.body.appendChild(renderer.domElement);

        loadAssets();
    }

    async function loadAssets() {
        try {
            // Carregando o Mapa com a sua lógica original
            const trackGltf = await loader.loadAsync(player.currentTrack);
            trackMesh = trackGltf.scene;
            
            // CORREÇÃO ESSENCIAL: Isso remove o erro de UV que você mencionou sem quebrar o modelo
            trackMesh.traverse(child => {
                if (child.isMesh && child.material) {
                    child.material.metalness = 0; // Resolve o erro de metalnessMap UV1
                    child.material.roughness = 1; // Resolve o erro de roughnessMap UV1
                }
            });
            
            scene.add(trackMesh);

            // Carregando o Carro
            const carGltf = await loader.loadAsync(player.currentCar);
            player.mesh = carGltf.scene;
            player.mesh.scale.set(3.5, 3.5, 3.5);
            
            // Posição inicial baseada no seu primeiro ponto da TRACK_DATA
            player.mesh.position.set(3895, 30, 454); 
            scene.add(player.mesh);

            gameStarted = true;
            animate();
        } catch (e) {
            console.error("Erro ao carregar:", e);
        }
    }

    function animate() {
        if(!gameStarted) return;
        requestAnimationFrame(animate);

        // Sua lógica de física original
        if(keys.w) player.speed += 0.05;
        if(keys.s) player.speed -= 0.08;
        player.speed *= 0.985;

        if(Math.abs(player.speed) > 0.05) {
            if(keys.a) player.mesh.rotation.y += 0.04;
            if(keys.d) player.mesh.rotation.y -= 0.04;
        }

        const move = new THREE.Vector3(0,0,1).applyQuaternion(player.mesh.quaternion).multiplyScalar(player.speed);
        player.mesh.position.add(move);

        // Sua lógica de Raycast para o chão original
        const ray = new THREE.Raycaster(new THREE.Vector3(player.mesh.position.x, 100, player.mesh.position.z), new THREE.Vector3(0,-1,0));
        const inter = ray.intersectObject(trackMesh, true);
        if(inter.length > 0) player.mesh.position.y = inter[0].point.y + 0.5;

        // Câmera seguindo o carro (Sua lógica original)
        const camOffset = new THREE.Vector3(0, 10, -30).applyQuaternion(player.mesh.quaternion);
        camera.position.copy(player.mesh.position).add(camOffset);
        camera.lookAt(player.mesh.position);

        renderer.render(scene, camera);
        document.getElementById('speedometer').innerText = Math.floor(player.speed * 100) + " KM/H";
    }

    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
</script>
</body>
</html>

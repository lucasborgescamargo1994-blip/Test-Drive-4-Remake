<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Test Drive 4 Remake - Full Restoration</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .dial-container {
            position: absolute; bottom: 20px; right: 20px;
            width: 180px; height: 180px;
            background: radial-gradient(circle, rgba(0,0,0,0.85) 20%, rgba(30,30,30,0.9) 100%);
            border-radius: 50%; border: 4px solid #555;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        #speed-val { font-size: 50px; font-weight: 900; font-style: italic; line-height: 1; color: #fff; text-shadow: 0 0 10px #0088ff; }
        #speed-unit { font-size: 14px; color: #aaa; }
        #gear-disp { position: absolute; bottom: -10px; background: #ffcc00; color: #000; font-weight: bold; padding: 5px 15px; border-radius: 10px; font-size: 18px; }
        
        #top-hud { position: absolute; top: 20px; left: 20px; display: flex; gap: 20px; }
        .stat-box { background: rgba(0,0,0,0.7); padding: 10px 15px; border-radius: 5px; border-left: 4px solid #ffcc00; color: white; min-width: 100px; }
        .stat-label { font-size: 11px; color: #bbb; text-transform: uppercase; }
        .stat-val { font-size: 22px; font-weight: bold; }

        #busted-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(200,0,0,0.6); display: none; 
            justify-content: center; align-items: center; flex-direction: column;
            color: white; z-index: 100;
        }
        #busted-text { font-size: 80px; font-weight: 900; transform: rotate(-5deg); text-shadow: 4px 4px #000; }
    </style>
</head>
<body>

<div id="hud-layer">
    <div id="top-hud">
        <div class="stat-box"><div class="stat-label">TIME</div><div class="stat-val" id="timer">00:00.00</div></div>
        <div class="stat-box" style="border-color: #ff3300"><div class="stat-label">POLICE</div><div class="stat-val" id="alert-lvl">CLEAR</div></div>
    </div>
    <div class="dial-container">
        <div id="speed-val">0</div>
        <div id="speed-unit">MPH</div>
        <div id="gear-disp">N</div>
    </div>
</div>

<div id="busted-overlay">
    <div id="busted-text">BUSTED!</div>
    <div style="background:black; padding: 5px 20px; margin-top:10px;">+5s PENALTY</div>
</div>

<script type="importmap">
  { "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // CONFIGURAÇÕES DE FÍSICA ORIGINAIS (O QUE VOCÊ GOSTOU)
    const MAX_SPEED = 2.8; const ACCEL = 0.015; const BRAKE = 0.04; const FRICTION = 0.99; const TURN = 0.032; const GRAVITY = 0.1;

    let scene, camera, renderer, clock;
    let player = { mesh: null, speed: 0, velocity: new THREE.Vector3(), onGround: false, lastSafePos: new THREE.Vector3() };
    let roadMesh, groundPlane, curve;
    let police = { mesh: null, active: false, cooldown: 0 };
    let gameTime = 0;
    let isPaused = false;
    const keys = { w: false, a: false, s: false, d: false };

    init();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 50, 400);
        clock = new THREE.Clock();

        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(50, 100, 50);
        sun.castShadow = true;
        scene.add(sun);

        createProTrack(); // Pista com muretas
        createGrass();
        loadCar();
        createPolice();

        document.addEventListener('keydown', e => { handleKey(e, true) });
        document.addEventListener('keyup', e => { handleKey(e, false) });
        animate();
    }

    function handleKey(e, state) {
        const k = e.key.toLowerCase();
        if(k === 'w' || e.key === 'ArrowUp') keys.w = state;
        if(k === 's' || e.key === 'ArrowDown') keys.s = state;
        if(k === 'a' || e.key === 'ArrowLeft') keys.a = state;
        if(k === 'd' || e.key === 'ArrowRight') keys.d = state;
    }

    function createProTrack() {
        const points = [
            new THREE.Vector3(0, 0, 0),
            new THREE.Vector3(100, 10, 150),
            new THREE.Vector3(300, 30, 200),
            new THREE.Vector3(500, 10, 0),
            new THREE.Vector3(300, -10, -200),
            new THREE.Vector3(100, 0, -150)
        ];
        curve = new THREE.CatmullRomCurve3(points);
        curve.closed = true;

        const shape = new THREE.Shape();
        const tw = 7; const wh = 1.5;
        shape.moveTo(-tw-1, wh); shape.lineTo(-tw-1, 0); shape.lineTo(tw+1, 0); shape.lineTo(tw+1, wh);
        shape.lineTo(tw, wh); shape.lineTo(tw, 0.1); shape.lineTo(-tw, 0.1); shape.lineTo(-tw, wh);
        
        const geo = new THREE.ExtrudeGeometry(shape, { steps: 400, extrudePath: curve, bevelEnabled: false });
        roadMesh = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: 0x444444, roughness: 0.8 }));
        roadMesh.receiveShadow = true;
        scene.add(roadMesh);
    }

    function createGrass() {
        const grass = new THREE.Mesh(new THREE.PlaneGeometry(2000, 2000), new THREE.MeshStandardMaterial({ color: 0x228B22 }));
        grass.rotation.x = -Math.PI/2;
        grass.position.y = -25;
        scene.add(grass);
    }

    function loadCar() {
        const loader = new GLTFLoader();
        loader.load('cobra.gltf', (gltf) => {
            player.mesh = gltf.scene;
            scene.add(player.mesh);
            player.mesh.position.copy(curve.getPointAt(0)).add(new THREE.Vector3(0,2,0));
        }, undefined, () => {
            player.mesh = new THREE.Mesh(new THREE.BoxGeometry(2,0.8,4), new THREE.MeshStandardMaterial({color: 0xff0000}));
            scene.add(player.mesh);
        });
    }

    function createPolice() {
        police.mesh = new THREE.Group();
        police.mesh.add(new THREE.Mesh(new THREE.BoxGeometry(2.2, 1, 4.5), new THREE.MeshStandardMaterial({color: 0x000000})));
        const lRed = new THREE.PointLight(0xff0000, 0, 20); lRed.position.set(-0.6, 1.2, 0);
        const lBlue = new THREE.PointLight(0x0000ff, 0, 20); lBlue.position.set(0.6, 1.2, 0);
        police.mesh.add(lRed, lBlue);
        police.mesh.userData = { lRed, lBlue };
        scene.add(police.mesh);
        police.mesh.position.y = -100;
    }

    function triggerBusted() {
        if(isPaused) return;
        isPaused = true;
        gameTime += 5;
        document.getElementById('busted-overlay').style.display = 'flex';
        police.active = false;
        police.mesh.position.y = -100;
        police.cooldown = 8; // Segundos de folga

        setTimeout(() => {
            document.getElementById('busted-overlay').style.display = 'none';
            player.speed = 0;
            player.mesh.position.copy(player.lastSafePos).add(new THREE.Vector3(0,1,0));
            isPaused = false;
        }, 3000);
    }

    function updatePhysics() {
        if(!player.mesh || isPaused) return;

        // ACELERAÇÃO
        if(keys.w) player.speed += ACCEL;
        if(keys.s) player.speed -= BRAKE;
        player.speed *= FRICTION;
        player.speed = Math.max(Math.min(player.speed, MAX_SPEED), -0.5);

        // DIREÇÃO (SÓ QUANDO ACELERA)
        if(Math.abs(player.speed) > 0.1) {
            const turnDir = player.speed > 0 ? 1 : -1;
            if(keys.a) player.mesh.rotation.y += TURN * turnDir;
            if(keys.d) player.mesh.rotation.y -= TURN * turnDir;
        }

        // MOVIMENTO
        player.velocity.set(0,0,1).applyQuaternion(player.mesh.quaternion).multiplyScalar(player.speed);
        if(!player.onGround) player.velocity.y -= GRAVITY;
        player.mesh.position.add(player.velocity);

        // COLISÃO COM PISTA E MURETA
        const ray = new THREE.Raycaster(player.mesh.position.clone().add(new THREE.Vector3(0,5,0)), new THREE.Vector3(0,-1,0));
        const hits = ray.intersectObject(roadMesh);

        if(hits.length > 0) {
            const h = hits[0].point.y;
            if(player.mesh.position.y < h + 0.5) {
                player.onGround = true;
                player.mesh.position.y = h;
                player.velocity.y = 0;
                player.lastSafePos.copy(player.mesh.position);
            } else { player.onGround = false; }
        } else {
            // FORA DA PISTA (BATE NA MURETA)
            player.speed *= 0.2;
            player.mesh.position.copy(player.lastSafePos);
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        const dt = clock.getDelta();

        if(!isPaused) {
            updatePhysics();
            
            // CÂMERA (SUAVE ATRÁS)
            if(player.mesh) {
                const camTarget = player.mesh.position.clone().add(new THREE.Vector3(0,4,-10).applyQuaternion(player.mesh.quaternion));
                camera.position.lerp(camTarget, 0.1);
                camera.lookAt(player.mesh.position.clone().add(new THREE.Vector3(0,1,0)));
            }

            // HUD
            gameTime += dt;
            const mph = Math.floor(Math.abs(player.speed) * 90);
            document.getElementById('speed-val').innerText = mph;
            document.getElementById('timer').innerText = gameTime.toFixed(2);
            document.getElementById('gear-disp').innerText = mph < 5 ? "N" : (mph < 60 ? "1" : (mph < 120 ? "2" : "3"));

            // POLÍCIA
            if(police.cooldown > 0) police.cooldown -= dt;
            if(!police.active && mph > 140 && police.cooldown <= 0) {
                police.active = true;
                police.mesh.position.copy(player.mesh.position).sub(player.velocity.clone().normalize().multiplyScalar(30));
            }
            if(police.active) {
                police.mesh.lookAt(player.mesh.position);
                police.mesh.translateZ(player.speed * 1.05 + 0.1);
                // Sirene
                const flash = Math.sin(Date.now() * 0.02) > 0;
                police.mesh.userData.lRed.intensity = flash ? 10 : 0;
                police.mesh.userData.lBlue.intensity = !flash ? 10 : 0;
                // Busted
                if(police.mesh.position.distanceTo(player.mesh.position) < 4) triggerBusted();
                document.getElementById('alert-lvl').innerText = "PURSUIT";
            } else { document.getElementById('alert-lvl').innerText = "CLEAR"; }
        }
        renderer.render(scene, camera);
    }
</script>
</body>
</html>




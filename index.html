<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Test Drive 4 Remake - Winter City</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; }
        canvas { display: block; }
        
        /* MENU INICIAL */
        #menu-container {
            position: absolute; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://raw.githubusercontent.com/lucasborgescamargo1994-blip/Test-Drive-4-Remake/main/thumb.jpg');
            background-size: cover; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000;
        }
        .menu-card {
            background: rgba(0, 0, 0, 0.85); padding: 40px; border-radius: 20px;
            border: 2px solid #ffcc00; text-align: center; backdrop-filter: blur(10px); width: 350px;
        }
        h1 { color: #ffcc00; margin-bottom: 20px; font-style: italic; }
        .field { margin-bottom: 20px; text-align: left; }
        label { display: block; font-size: 12px; color: #aaa; text-transform: uppercase; margin-bottom: 5px; }
        select, input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; box-sizing: border-box; }
        button { 
            width: 100%; padding: 15px; border-radius: 5px; border: none; 
            background: #ffcc00; color: #000; font-weight: bold; font-size: 18px;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        button:hover { background: #fff; transform: scale(1.02); }

        /* HUD JOGO */
        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        .dial-container {
            position: absolute; bottom: 30px; right: 30px; width: 160px; height: 160px;
            background: radial-gradient(circle, rgba(0,0,0,0.8) 20%, #111 100%);
            border-radius: 50%; border: 4px solid #555; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #speed-val { font-size: 50px; font-weight: 900; font-style: italic; color: #fff; text-shadow: 0 0 10px #0088ff; line-height: 1; }
        #gear-disp { position: absolute; bottom: -10px; background: #ffcc00; color: #000; padding: 5px 20px; border-radius: 10px; font-weight: bold; }
        
        #loading-screen { position: absolute; width: 100%; height: 100%; background: #000; display: none; justify-content: center; align-items: center; z-index: 3000; font-size: 20px; color: #ffcc00; }
    </style>
</head>
<body>

<div id="loading-screen">CARREGANDO ASSETS DO GITHUB...</div>

<div id="menu-container">
    <div class="menu-card">
        <h1>TD4 REMAKE</h1>
        <div class="field">
            <label>Veículo</label>
            <select id="player-car-select"></select>
        </div>
        <div class="field">
            <label>Oponentes</label>
            <input type="number" id="bot-count" value="3" min="0" max="8">
        </div>
        <div class="field">
            <label>Circuito</label>
            <select id="track-select">
                <option value="custom">Winter City (Burnout 3)</option>
                <option value="original">Test Track (Original)</option>
            </select>
        </div>
        <button id="start-btn">RACE START</button>
    </div>
</div>

<div id="hud-layer">
    <div style="position: absolute; top: 20px; left: 20px;">
        <div style="background:rgba(0,0,0,0.8); padding:15px; border-left: 5px solid #ffcc00;">
            <div style="font-size:11px; color:#bbb;">TIME</div>
            <div id="timer" style="font-size:24px; font-weight: bold;">00:00.00</div>
        </div>
    </div>
    <div class="dial-container">
        <div id="speed-val">0</div>
        <div style="font-size:12px; color:#aaa;">MPH</div>
        <div id="gear-disp">N</div>
    </div>
</div>

<script type="importmap">
  { "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // CONFIGURAÇÕES DE ASSETS
    const GITHUB_RAW = "https://raw.githubusercontent.com/lucasborgescamargo1994-blip/Test-Drive-4-Remake/main/";
    const TRACK_URL = "https://github.com/lucasborgescamargo1994-blip/Test-Drive-4-Remake/raw/refs/heads/main/burnout_3_winter_city.glb";
    
    const CAR_MODELS = [
        { name: "Shelby Cobra", file: "cobra.glb" },
        { name: "Jaguar XJ220", file: "jaguar.glb" },
        { name: "Viper RT/10", file: "viper.glb" }
    ];

    // FÍSICA
    const PHYSICS = { maxSpeed: 2.8, accel: 0.018, brake: 0.045, friction: 0.985, turn: 0.035 };

    let scene, camera, renderer, clock;
    let player = { mesh: null, speed: 0, velocity: new THREE.Vector3(), lastSafePos: new THREE.Vector3(0, 1, 0) };
    let opponents = [];
    let trackModel = null;
    let gameStarted = false;
    let keys = { w: false, a: false, s: false, d: false };

    // Inicializar Menu
    const carSelect = document.getElementById('player-car-select');
    CAR_MODELS.forEach((car, i) => {
        let opt = document.createElement('option');
        opt.value = i; opt.textContent = car.name;
        carSelect.appendChild(opt);
    });

    document.getElementById('start-btn').onclick = startRace;

    function initScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222233);
        scene.fog = new THREE.Fog(0x222233, 100, 600);
        clock = new THREE.Clock();

        camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.1, 2000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(50, 150, 50);
        scene.add(sun);
    }

    async function loadCar(file, isPlayer, index = 0) {
        const loader = new GLTFLoader();
        const url = GITHUB_RAW + file;
        try {
            const gltf = await loader.loadAsync(url);
            const mesh = gltf.scene;
            scene.add(mesh);
            if(isPlayer) {
                player.mesh = mesh;
            } else {
                opponents.push({ mesh, progress: index * 0.05, speed: 0.0002 + Math.random() * 0.0002 });
            }
        } catch (e) {
            console.warn("Usando fallback para:", file);
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(2,1,4), new THREE.MeshStandardMaterial({color: isPlayer?0xff0000:0x0000ff}));
            scene.add(mesh);
            if(isPlayer) player.mesh = mesh; else opponents.push({ mesh, progress: index*0.05, speed: 0.0003 });
        }
    }

    async function startRace() {
        document.getElementById('menu-container').style.display = 'none';
        document.getElementById('loading-screen').style.display = 'flex';

        initScene();

        const trackType = document.getElementById('track-select').value;
        const loader = new GLTFLoader();

        // Carregar Pista
        if(trackType === 'custom') {
            try {
                const gltf = await loader.loadAsync(TRACK_URL);
                trackModel = gltf.scene;
                scene.add(trackModel);
            } catch (e) { console.error("Falha na pista custom"); }
        } else {
            // Pista Original (Fallback)
            const geo = new THREE.TorusGeometry(200, 10, 16, 100);
            trackModel = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({color: 0x333333}));
            trackModel.rotation.x = Math.PI/2;
            scene.add(trackModel);
        }

        // Carregar Carros
        const playerIdx = document.getElementById('player-car-select').value;
        const botCount = parseInt(document.getElementById('bot-count').value);

        await loadCar(CAR_MODELS[playerIdx].file, true);

        for(let i = 0; i < botCount; i++) {
            const carData = CAR_MODELS[i % CAR_MODELS.length]; // Repete se faltar modelos
            await loadCar(carData.file, false, i + 1);
        }

        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('hud-layer').style.display = 'block';

        window.addEventListener('keydown', e => handleKey(e, true));
        window.addEventListener('keyup', e => handleKey(e, false));
        
        gameStarted = true;
        animate();
    }

    function handleKey(e, state) {
        const k = e.key.toLowerCase();
        if(k === 'w' || e.key === 'ArrowUp') keys.w = state;
        if(k === 's' || e.key === 'ArrowDown') keys.s = state;
        if(k === 'a' || e.key === 'ArrowLeft') keys.a = state;
        if(k === 'd' || e.key === 'ArrowRight') keys.d = state;
    }

    function updatePhysics() {
        if(!player.mesh || !trackModel) return;

        // Input
        if(keys.w) player.speed += PHYSICS.accel;
        if(keys.s) player.speed -= PHYSICS.brake;
        player.speed *= PHYSICS.friction;
        player.speed = Math.max(Math.min(player.speed, PHYSICS.maxSpeed), -0.5);

        // Curva
        if(Math.abs(player.speed) > 0.05) {
            const tDir = player.speed > 0 ? 1 : -1;
            if(keys.a) player.mesh.rotation.y += PHYSICS.turn * tDir;
            if(keys.d) player.mesh.rotation.y -= PHYSICS.turn * tDir;
        }

        // Movimento e Colisão
        const velocity = new THREE.Vector3(0,0,1).applyQuaternion(player.mesh.quaternion).multiplyScalar(player.speed);
        const nextPos = player.mesh.position.clone().add(velocity);

        // Raycast para o chão e muretas
        const downRay = new THREE.Raycaster(nextPos.clone().add(new THREE.Vector3(0, 10, 0)), new THREE.Vector3(0,-1,0));
        const hits = downRay.intersectObject(trackModel, true);

        if(hits.length > 0) {
            player.mesh.position.copy(nextPos);
            player.mesh.position.y = hits[0].point.y; // Ajusta altura conforme terreno
            player.lastSafePos.copy(player.mesh.position);
        } else {
            // Bateu ou saiu da pista
            player.speed *= 0.5;
            player.mesh.position.lerp(player.lastSafePos, 0.1);
        }
    }

    function animate() {
        if(!gameStarted) return;
        requestAnimationFrame(animate);
        const dt = clock.getDelta();

        updatePhysics();

        // Bots
        opponents.forEach((bot, i) => {
            bot.mesh.translateZ(0.5); // Movimento simples para frente
            bot.mesh.rotation.y += 0.005; // Fazem um círculo se não houver curva definida
        });

        // Câmera
        if(player.mesh) {
            const camOffset = new THREE.Vector3(0, 4, -12).applyQuaternion(player.mesh.quaternion);
            camera.position.lerp(player.mesh.position.clone().add(camOffset), 0.1);
            camera.lookAt(player.mesh.position);
        }

        // HUD
        const mph = Math.floor(Math.abs(player.speed) * 110);
        document.getElementById('speed-val').innerText = mph;
        document.getElementById('timer').innerText = clock.getElapsedTime().toFixed(2);
        document.getElementById('gear-disp').innerText = mph < 10 ? "N" : (mph < 70 ? "1" : "2");

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
